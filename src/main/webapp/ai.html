<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>AI 智能助手</title>
  <!-- inline favicon to avoid /favicon.ico 404 -->
  <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><rect width='16' height='16' fill='%231976D2'/><text x='8' y='11' font-size='10' text-anchor='middle' fill='white'>AI</text></svg>">
  <style>
    body { font-family: Arial, sans-serif; margin:16px; }
    .chat { max-width:900px; margin:0 auto; }
    .messages { border:1px solid #eee; padding:12px; height:60vh; overflow:auto; background:#fafafa }
    .msg { margin-bottom:8px }
    .msg.user { text-align:right }
    .msg .bubble { display:inline-block; padding:8px 12px; border-radius:8px; max-width:80%; }
    .msg.user .bubble { background:#2196F3; color:white }
    .msg.ai .bubble { background:#f1f1f1; color:#222 }
    .controls { margin-top:12px; display:flex; gap:8px }
    textarea { width:100%; height:80px }
    .status { font-size:12px; color:#666; margin-top:6px }
    /* sr-only for accessibility labels */
    .sr-only { position:absolute !important; width:1px !important; height:1px !important; padding:0 !important; margin:-1px !important; overflow:hidden !important; clip:rect(0 0 0 0) !important; white-space:nowrap !important; border:0 !important; }
  </style>
</head>
<body>
  <div class="chat">
    <h2>AI 智能助手</h2>
    <label class="sr-only" for="userInput">输入问题</label>
    <div class="messages" id="messages"></div>
    <div class="controls">
      <textarea id="userInput" placeholder="输入问题，支持中文"></textarea>
      <div style="display:flex; flex-direction:column; gap:8px; width:140px;">
        <button id="sendBtn" class="btn">发送</button>
        <button id="clearBtn" class="btn">清除</button>
        <div id="status" class="status"></div>
      </div>
    </div>
  </div>

  <script>
    const base = window.location.origin + window.location.pathname.replace(/\/[^/]*$/, '');
    const messagesEl = document.getElementById('messages');
    const userInput = document.getElementById('userInput');
    const sendBtn = document.getElementById('sendBtn');
    const clearBtn = document.getElementById('clearBtn');
    const statusEl = document.getElementById('status');

    function appendMessage(kind, html) {
      const div = document.createElement('div');
      div.className = 'msg ' + kind;
      const b = document.createElement('div');
      b.className = 'bubble';
      b.innerHTML = html;
      div.appendChild(b);
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      return b;
    }

    // 页面初始化时显示 AI 的默认欢迎消息
    (function showInitialGreeting(){
      const welcome = '您好，我是你的个人网盘助手，有什么可以帮到您的？';
      appendMessage('ai', escapeHtml(welcome));
      statusEl.textContent = '';
    })();

    async function send() {
      const text = userInput.value.trim();
      if (!text) return;
      appendMessage('user', text);
      userInput.value = '';
      statusEl.textContent = '连接中...';

      try {
        // prepare payload using OpenAI-compatible chat completion shape
        const payload = {
          model: 'qwen-plus',
          messages: [
            { role: 'system', content: '你是网盘的 AI 助手，可以帮助用户管理文件、快速回答关于网盘的问答，并可给出操作建议。' },
            { role: 'user', content: text }
          ],
          // request streaming
          stream: true,
          max_tokens: 1024
        };

        const res = await fetch(base + '/api/ai/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        if (!res.ok) {
          const err = await res.text();
          appendMessage('ai', '错误: ' + res.status + '\n' + err);
          statusEl.textContent = '错误';
          return;
        }

        statusEl.textContent = '正在接收 AI 响应...';
        const reader = res.body.getReader();
        const decoder = new TextDecoder('utf-8');
        let aiBubble = appendMessage('ai', '');

        let done = false;
        while (!done) {
          const { value, done: rdone } = await reader.read();
          if (rdone) { done = true; break; }
          const chunk = decoder.decode(value, { stream: true });
          // append raw chunk; in compatible mode the server may send SSE-like data or plain JSON chunks
          aiBubble.innerHTML += escapeHtml(chunk);
          messagesEl.scrollTop = messagesEl.scrollHeight;
        }
        statusEl.textContent = '完成';
      } catch (e) {
        appendMessage('ai', '请求失败: ' + e.message);
        statusEl.textContent = '失败';
      }
    }

    sendBtn.addEventListener('click', send);
    clearBtn.addEventListener('click', () => { messagesEl.innerHTML = ''; statusEl.textContent = ''; });

    function escapeHtml(str) {
      return str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
    }
  </script>
</body>
</html>
