<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>注册 - 个人云盘</title>
  <link rel="icon" href="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><rect width='16' height='16' fill='%231976D2'/><text x='8' y='11' font-size='10' text-anchor='middle' fill='white'>H</text></svg>">
  <link rel="stylesheet" href="css/style.css" />
</head>
<body>
  <div style="max-width:420px;margin:60px auto;padding:24px;border:1px solid #eee;border-radius:8px;background:#fff;">
    <h2>注册新用户</h2>
    <form id="registerForm">
      <div style="margin-top:12px;"><label for="regUsername">用户名</label><input id="regUsername" name="username" type="text" autocomplete="username" style="width:100%;padding:8px;margin-top:6px;" /></div>
      <div style="margin-top:12px;"><label for="regPassword">密码</label><input id="regPassword" name="password" type="password" autocomplete="new-password" style="width:100%;padding:8px;margin-top:6px;" /></div>
      <div style="margin-top:12px;"><label for="regPassword2">确认密码</label><input id="regPassword2" type="password" autocomplete="new-password" style="width:100%;padding:8px;margin-top:6px;" /></div>

      <div style="display:flex;gap:12px;margin-top:18px;">
        <button id="doRegisterBtn" type="submit" class="btn btn-primary">注册</button>
        <a href="login.html" style="align-self:center;">去登录</a>
      </div>
    </form>
    <div id="msg" style="margin-top:12px;color:#b00020;"></div>
  </div>

  <script>
    (function(){
      const base = window.location.origin + window.location.pathname.replace(/\/[^^/]*$/, '');
      const msgEl = document.getElementById('msg');
      function showMsg(m, err){ msgEl.textContent = m; msgEl.style.color = err ? '#b00020' : '#1a7f1a'; }

      const form = document.getElementById('registerForm');
      form.addEventListener('submit', async (ev) => {
        ev.preventDefault();
        msgEl.textContent = '';
        const u = document.getElementById('regUsername').value.trim();
        const p = document.getElementById('regPassword').value;
        const p2 = document.getElementById('regPassword2').value;
        if (!u || !p) { showMsg('用户名和密码不能为空', true); return; }
        if (u.length < 3) { showMsg('用户名需至少 3 个字符', true); return; }
        if (p.length < 4) { showMsg('密码需至少 4 个字符', true); return; }
        if (p !== p2) { showMsg('两次输入的密码不一致', true); return; }

        try {
          const body = new URLSearchParams();
          body.append('action','register');
          body.append('username', u);
          body.append('password', p);
          body.append('debug', '1');
          const resp = await fetch(base + '/api/auth', { method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body: body.toString() });
          // handle non-2xx responses gracefully
          if (!resp.ok) {
            let text;
            try { text = await resp.text(); let json = JSON.parse(text); showMsg(json.message || JSON.stringify(json), true); }
            catch (e) { showMsg('注册失败: ' + (text || resp.statusText || resp.status), true); }
            return;
          }
          const res = await resp.json();
          if (res && res.success) {
            showMsg('注册成功，正在跳转...');
            setTimeout(() => { window.location.href = base + '/index.html'; }, 1200);
          } else {
            showMsg(res && res.message ? res.message : '注册失败', true);
          }
        } catch (er) {
          showMsg('注册请求失败: ' + er.message, true);
        }
      });
    })();
  </script>
</body>
</html>
